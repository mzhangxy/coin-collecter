name: Bot-Hosting Auto Claim

on:
  workflow_dispatch: # 允许在 Actions 页面手动点击运行按钮进行测试

jobs:
  claim-coins:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 恢复 hCaptcha 模型缓存
        id: cache-models
        uses: actions/cache@v3
        with:
          path: ~/.hcaptcha_challenger
          key: ${{ runner.os }}-hcaptcha-models
          restore-keys: |
            ${{ runner.os }}-hcaptcha-models

      - name: 安装 Python 依赖
        run: |
          python -m pip install --upgrade pip
          pip install playwright pyyaml
          pip install hcaptcha-challenger[playwright]

      - name: 安装 Playwright 浏览器
        run: python -m playwright install chromium

      - name: 运行自动收集脚本
        env:
          AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}
          # 新增：将你设置好的 API Key 注入到环境变量中
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python bot_claimer.py

      - name: 上传调试截图和源码 (仅在运行结束或失败时)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: |
            ./*.png
            ./*.html
          retention-days: 3
